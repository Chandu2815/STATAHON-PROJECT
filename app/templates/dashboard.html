<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MoSPI Data Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-size: 1.5em;
            font-weight: 600;
        }
        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-info {
            text-align: right;
        }
        .user-role {
            font-size: 0.85em;
            opacity: 0.9;
            text-transform: uppercase;
        }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-logout:hover {
            background: white;
            color: #667eea;
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .welcome-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .welcome-section h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .welcome-section p {
            color: #666;
            font-size: 1.1em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 0.95em;
        }
        .query-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .query-section h3 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .form-group select, .form-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-query {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-query:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-query:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .results-header h3 {
            color: #333;
        }
        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-export:hover {
            background: #218838;
        }
        .results-table {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
        }
        .alert-error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">üìä MoSPI Data Portal</div>
        <div class="navbar-user">
            <div class="user-info">
                <div id="userName">Loading...</div>
                <div class="user-role" id="userRole">Loading...</div>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="welcome-section">
            <h2>Welcome to MoSPI Data Portal</h2>
            <p>Query and analyze data from Ministry of Statistics & Programme Implementation</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìÅ</div>
                <div class="stat-value">5</div>
                <div class="stat-label">Available Datasets</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="totalRecords">517,029</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üîç</div>
                <div class="stat-value" id="queryCount">0</div>
                <div class="stat-label">Queries Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="userCredits">10.0</div>
                <div class="stat-label">Available Credits</div>
            </div>
        </div>

        <div class="query-section">
            <h3>üîç Query Data</h3>
            
            <form id="queryForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="dataset">Dataset</label>
                        <select id="dataset" required>
                            <option value="">Select Dataset</option>
                            <option value="4">Household Survey (PLFS)</option>
                            <option value="5">Person Survey (PLFS)</option>
                            <option value="1">Sample Census Data</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state">
                            <option value="">All States</option>
                            <option value="TELANGANA">Telangana</option>
                            <option value="ANDHRA PRADESH">Andhra Pradesh</option>
                            <option value="MAHARASHTRA">Maharashtra</option>
                            <option value="KARNATAKA">Karnataka</option>
                            <option value="TAMIL NADU">Tamil Nadu</option>
                            <option value="KERALA">Kerala</option>
                            <option value="WEST BENGAL">West Bengal</option>
                            <option value="GUJARAT">Gujarat</option>
                            <option value="RAJASTHAN">Rajasthan</option>
                            <option value="UTTAR PRADESH">Uttar Pradesh</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender">
                            <option value="">All</option>
                            <option value="MALE">Male</option>
                            <option value="FEMALE">Female</option>
                            <option value="TRANSGENDER">Transgender</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ageGroup">Age Group</label>
                        <select id="ageGroup">
                            <option value="">All Ages</option>
                            <option value="0-14">0-14 (Children)</option>
                            <option value="15-29">15-29 (Youth)</option>
                            <option value="30-59">30-59 (Adults)</option>
                            <option value="60-100">60+ (Senior)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="limit">Records Limit</label>
                        <input type="number" id="limit" value="100" min="1" max="10000">
                    </div>
                </div>
                <button type="submit" class="btn-query">Run Query</button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Executing query...</p>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h3>Query Results (<span id="resultCount">0</span> records)</h3>
                <button class="btn-export" onclick="exportResults()">üì• Export CSV</button>
            </div>
            <div class="results-table" id="resultsTable"></div>
        </div>
    </div>

    <script>
        let currentResults = [];

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return token;
        }

        // Load user info
        async function loadUserInfo() {
            const token = checkAuth();
            if (!token) return;

            const username = localStorage.getItem('username');
            const role = localStorage.getItem('user_role');
            
            document.getElementById('userName').textContent = username || 'User';
            document.getElementById('userRole').textContent = role || 'public';

            // Fetch credits
            try {
                const response = await fetch('/api/v1/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    const userData = await response.json();
                    const creditsDisplay = userData.credits >= 999999 ? 'Unlimited' : userData.credits.toFixed(2);
                    document.getElementById('userCredits').textContent = creditsDisplay;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('username');
            window.location.href = '/login';
        }

        // Query form submission
        document.getElementById('queryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = checkAuth();
            if (!token) return;

            const dataset = document.getElementById('dataset').value;
            const state = document.getElementById('state').value;
            const gender = document.getElementById('gender').value;
            const ageGroup = document.getElementById('ageGroup').value;
            const limit = document.getElementById('limit').value;

            if (!dataset) {
                alert('Please select a dataset');
                return;
            }

            // Build query URL
            let queryUrl = `/api/v1/query?dataset=${dataset}&limit=${limit}`;
            if (state) queryUrl += `&state=${state}`;
            if (gender) queryUrl += `&gender=${gender}`;
            if (ageGroup) queryUrl += `&age_group=${ageGroup}`;

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            try {
                const response = await fetch(queryUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    currentResults = data.data || [];
                    displayResults(currentResults);
                    document.getElementById('queryCount').textContent = 
                        parseInt(document.getElementById('queryCount').textContent) + 1;
                    
                    // Reload user credits
                    loadUserInfo();
                } else {
                    alert('Query failed: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        // Display results
        function displayResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsTable = document.getElementById('resultsTable');
            const resultCount = document.getElementById('resultCount');

            if (!results || results.length === 0) {
                resultsTable.innerHTML = '<div class="no-results">No results found for your query</div>';
                resultCount.textContent = '0';
                resultsSection.style.display = 'block';
                return;
            }

            // Get all unique keys from results
            const keys = [...new Set(results.flatMap(obj => Object.keys(obj)))];

            // Create table
            let html = '<table><thead><tr>';
            keys.forEach(key => {
                html += `<th>${key}</th>`;
            });
            html += '</tr></thead><tbody>';

            results.forEach(row => {
                html += '<tr>';
                keys.forEach(key => {
                    html += `<td>${row[key] !== null && row[key] !== undefined ? row[key] : '-'}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            resultsTable.innerHTML = html;
            resultCount.textContent = results.length;
            resultsSection.style.display = 'block';
        }

        // Export results
        function exportResults() {
            if (!currentResults || currentResults.length === 0) {
                alert('No results to export');
                return;
            }

            const keys = Object.keys(currentResults[0]);
            let csv = keys.join(',') + '\n';

            currentResults.forEach(row => {
                const values = keys.map(key => {
                    const value = row[key];
                    return typeof value === 'string' ? `"${value}"` : value;
                });
                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mospi_query_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Initialize
        loadUserInfo();
    </script>
</body>
</html>
